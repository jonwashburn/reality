name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install elan
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
          echo "$HOME/.elan/bin" >> $GITHUB_PATH
      - name: Build
        run: |
          lake build
      - name: Sorry gate (numerics/constants)
        run: |
          ! grep -R --line-number -E '\bsorry\b' IndisputableMonolith/Numerics IndisputableMonolith/Constants || (echo "Found 'sorry' in numerics/constants" && exit 1)
      - name: Verify numeric certificates
        run: |
          python3 scripts/verify_certs.py
name: Lean CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  head_build:
    name: Fast head check (lean quick checks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install elan (Lean toolchain)
        shell: bash
        run: |
          set -euxo pipefail
          curl -sSfL https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | bash -s -- -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH
      - name: Cache Lake packages
        uses: actions/cache@v4
        with:
          path: ./.lake/packages
          key: ${{ runner.os }}-lake-${{ hashFiles('lake-manifest.json') }}
          restore-keys: |
            ${{ runner.os }}-lake-
      - name: Slice monolith head and run quick checks
        shell: bash
        run: |
          set -euxo pipefail
          source $HOME/.elan/env
          cp IndisputableMonolith.lean IndisputableMonolith.full.lean
          head -n 6000 IndisputableMonolith.full.lean > IndisputableMonolith.lean
          lake update
          lake env -- lean -q IndisputableMonolith/Core.lean -o /dev/null
          lake env -- lean -q IndisputableMonolith.lean -o /dev/null
          lake exe ci_checks | sed -e 's/.*/HEAD: &/'
      - name: CI guard (no sorry/admit, report axiom count)
        shell: bash
        run: |
          set -euxo pipefail
          chmod +x scripts/ci_guard.sh
          ./scripts/ci_guard.sh

  full_quick:
    name: Full quick checks (lean) â€” allow failure
    runs-on: ubuntu-latest
    needs: head_build
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Install elan (Lean toolchain)
        shell: bash
        run: |
          set -euxo pipefail
          curl -sSfL https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | bash -s -- -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH
      - name: Cache Lake packages
        uses: actions/cache@v4
        with:
          path: ./.lake/packages
          key: ${{ runner.os }}-lake-${{ hashFiles('lake-manifest.json') }}
          restore-keys: |
            ${{ runner.os }}-lake-
      - name: Run lean quick checks on full monolith
        shell: bash
        run: |
          set -euxo pipefail
          source $HOME/.elan/env
          lake update
          lake env -- lean -q IndisputableMonolith/Core.lean -o /dev/null
          lake env -- lean -q IndisputableMonolith.lean -o /dev/null
          lake exe ci_checks | sed -e 's/.*/FULL: &/'
      - name: CI guard (no sorry/admit, report axiom count)
        shell: bash
        run: |
          set -euxo pipefail
          chmod +x scripts/ci_guard.sh
          ./scripts/ci_guard.sh

  science_gates:
    name: Science gates (QG harness)
    runs-on: ubuntu-latest
    needs: head_build
    steps:
      - uses: actions/checkout@v4
      - name: Install elan (Lean toolchain)
        shell: bash
        run: |
          set -euxo pipefail
          curl -sSfL https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | bash -s -- -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH
      - name: Cache Lake packages
        uses: actions/cache@v4
        with:
          path: ./.lake/packages
          key: ${{ runner.os }}-lake-${{ hashFiles('lake-manifest.json') }}
          restore-keys: |
            ${{ runner.os }}-lake-
      - name: Build and run QG harness
        shell: bash
        run: |
          set -euxo pipefail
          source $HOME/.elan/env
          lake update
          lake build qg_harness
          lake exe qg_harness | tee harness.out
          grep -q "QGHarness: PASS" harness.out
          grep -q "FalsifiersHarnessCert: OK" harness.out
